# Code Deploy
## Automate software deployment to verify  of compute service such as ec2, fargate, lambda
****************************************************************************************
# Install the CodeDeploy agent for Amazon Linux or RHEL
### Ref: https://docs.aws.amazon.com/codedeploy/latest/userguide/codedeploy-agent-operations-install-linux.html
****************************************************************************************
# Deploy Code deploy

## Steps for code deploy with s3 have artifacts and install it in ec2
1. Create IAM role for Code Deloy with s3 read only access
- service type: code deploy
- role name; codedeploy-role
- policy: AWSCodeDeployROle + s3ReadOnly

2. Create IAM role for ec2 with s3 readOnlyAccess
- service type: ec2
- role name: ec2-s3ReadOnly-role
- policy: s3ReadOnly

3. Launch Ec2 inst with appropriate role
- attach the role created in step2

4. Install code deploy agent
#### Ref "https://docs.aws.amazon.com/codedeploy/latest/userguide/codedeploy-agent-operations-install-linux.html"
- install agent
```sh
sudo yum update
sudo yum install ruby
sudo yum install wget
cd /home/ec2-user
# Chane bucket name and region
wget https://bucket-name.s3.region-identifier.amazonaws.com/latest/install
```
#### To get bucket name as per your region
### Ref https://docs.aws.amazon.com/codedeploy/latest/userguide/resource-kit.html#resource-kit-bucket-names
```sh
wget https://aws-codedeploy-eu-north-1.s3.eu-north-1.amazonaws.com/latest/install
chmod +x ./install
sudo ./install auto
sudo service codedeploy-agent start
sudo service codedeploy-agent status
```

5. Configure code deploy service
- Create Application
    - Name: demoappluication
    - Compute Platform: Ec2/Onpremises
- Create deployment Group
    - Name: demo-deployment-group
    - service-role: select the IAM role created in step 1
    - Environment variable: Amazon Ec2 instances -> Select Tag of ec2 instanc 
- create Deployment
- Start Deployemnt: click om **create Deployment**
- deployment Setting
    #### Generally code deploy looks for appspec.yaml, for what operation needs to perform

##### appspec.yaml
```yml
version: 0.0
os: linux
files:
   - source: /
     destination: /tmp
hooks:
   BeforeInstall:
    - location: scripts/runbuild.sh # =This script run to cp file from s3 to local
      runas: root
```
##### runbuild.sh
```sh
#!/bin/bash
aws s3 cp s3://code-build-demo-project/demo-build-project/my-app /tmp/
```
    - Select revision type: where is my application stored in amazon s3 or github
